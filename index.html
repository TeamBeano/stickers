<html>
<head>
	<script src="https://code.jquery.com/jquery-2.1.4.js"></script>

  <script type="text/javascript" src="http://gabelerner.github.io/canvg/rgbcolor.js"></script>
  <script type="text/javascript" src="http://gabelerner.github.io/canvg/StackBlur.js"></script>
  <script type="text/javascript" src="http://gabelerner.github.io/canvg/canvg.js"></script>

	<script src="https://cdn.rawgit.com/hammerjs/touchemulator/master/touch-emulator.js"></script>
	<script> TouchEmulator(); </script>
	<script src="http://hammerjs.github.io/dist/hammer.js"></script>

	<script type="text/javascript">
		$(document).ready(function() {

			// get a reference to an element
			var stage = document.getElementById('draggable');
			$stage = jQuery(stage);

			// create a manager for that element
			var manager = new Hammer.Manager(stage);

			// create recognizers
			var Pan = new Hammer.Pan();
			var Rotate = new Hammer.Rotate();
			var Pinch = new Hammer.Pinch();

			// use them together
			Rotate.recognizeWith([Pan, Pinch]);
			// Pinch.recognizeWith([Rotate, Pan]);

			// add the recognizers
			manager.add(Pan);
			manager.add(Rotate);
			manager.add(Pinch);

			var posX=0,
				posY=0,
				scale=1,
				rotation= 0;

			var liveScale = 1;
			var currentRotation = 0;
			manager.on('rotatestart', function(e) {
				currentRotation = e.rotation
			});
			manager.on('rotatemove', function(e) {
				rotation = Math.round(liveScale * e.rotation) - currentRotation;
			});

			var deltaX = 0;
			var deltaY = 0;
			manager.on('panmove', function(e) {
				posX = deltaX + (e.deltaX);
				posY = deltaY + (e.deltaY);
			});
			manager.on('panend', function(e) {
				deltaX = deltaX + e.deltaX;
				deltaY = deltaY + e.deltaY;
			});

			var currentScale = 1;
			function getRelativeScale(scale) {
				return scale * currentScale;
			}
			manager.on('pinchmove', function(e) {
				scale = getRelativeScale(e.scale);
			});
			manager.on('pinchend', function(e) {
				currentScale = getRelativeScale(e.scale);
				liveScale = currentScale;
			});

			manager.on('panmove pinchmove rotatemove', function(ev) {
				stage.setAttribute('transform', 'translate('+posX+','+posY+') rotate('+rotation+', '+(stage.width.animVal.value/2)*scale+', '+(stage.height.animVal.value/2)*scale+') scale('+scale+')')
	    });

      $('.save').on('click', function() {
        var xml  = new XMLSerializer().serializeToString(document.getElementById('graph'))
        canvg(document.getElementById('canvas'), xml, {renderCallback: function functionName() {
          var link = document.createElement("a");
          link.download = 'your-picture.png';
          link.href = document.getElementById('canvas').toDataURL();
          link.click();
        }});
      })
		});
	</script>
  <style media="screen">
    body{
      margin: 0;
      padding: 0;
    }
		#draggable {
        cursor: move;
				transform-origin: center;
    }
  </style>
</head>
<body>
  <svg id='graph' height="784px" width="532px" xmlns="http://www.w3.org/2000/svg">
    <image xlink:href="pic.jpg" height="784px" width="532px"/>
  	<image id="draggable" xlink:href="23.png" height="392px" width="266px" />
  </svg>
  <a href="#" class='save'>Save</a>
  <canvas id="canvas" width="1000px" height="600px" style='display:none;'></canvas>
</body>
</html>
